---
title: 'Characterisation of MSC in clinical trial reports: analysis of published descriptors'
author: "Emma Rand"
date: "16/01/2020"
output:
  html_document: default
  svg_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

# Figures specification
* titled
* cited in numerical order in the text using Arabic numbers. 
* no additional charges for color. 
* submitted as individual files
* labeled with the Corresponding Author name, the appropriate figure number, and  orientation (e.g., “top”)
* Figures may be submitted as multipart panels.
*  *.svg* or .eps 
* final publication size; 1-column width or, if necessary, 1½ column width. The  2-column width should not be used unless necessary.
* 1.0 column = 3.2 Inches, 8.2 Centimeters, 19.25 Picas
* 1.5 column = 4.5 Inches, 11.4 Centimeters, 27.00 Picas
* 2.0 column = 5.8 Inches, 14.8 Centimeters, 35.00 Picas
* height of all figures <= to 9.6inches / 24.5 cm / 58 picas.
* Calibri font sub sans serif Arial
* Multipanel labeled using uppercase 12-point Calibri Bold. 
* minimum text size of 6 points
* bold enough to be easily read after reduction, as should all symbols used in the * figure. Line or bar graphs or flow charts with text should be created in black and white, not shades of gray, which are difficult to reproduce in even tones. If more than two sets of data are represented, use of fill patterns or colors (not gray) is suggested to present the data clearly.
* Minimum resolution is 300 dpi for color and grayscale figures, 600 dpi for  combination halftones, and 1000 dpi for line art.



```{r pkg}
library(tidyverse)
# library(readxl)
# library(kableExtra)
library(grid)
library(patchwork)
library(janitor)

```

```{r}

# palette
pal <- viridisLite::viridis(6)

# figure saving settings
units = "in"
fig_w <- 3.5
fig_w_1.5 <- 5
fig_w_2 <- 7.3
fig_h <- fig_w
device <- "svg"

```

## write to file
```{r}
# file <- "data/checked_processed_aw_corrections.csv"
# write_csv(dat, file)
```


# Read in the processed and corrected data

```{r}
file <- "data/checked_processed_aw_corrections.csv"
dat <- read_csv(file, skip = 1)
# write(names(dat), "data/varnames.txt")

```


```{r}
# put levels in
source("levels.R")
```

# Figures

## Fig 1 - Search

### prep

```{r data-prep-fig1}
# create data for funnel 1A
# short names for proof of method
orig <- data.frame(step_names = c("1.mesenchymal",
                                  "2.article",
                                  "3.cell tissue etc",
                                  "4.clinical etc",
                                  "5.not biotech etc",
                                  "6.exc conf etc"),
                   n = c(65706,
                         47031,
                         7814,
                         5502,
                         2055,
                         1986))

# prep polygons that connect
to_poly_orig <- orig %>%
  arrange(n) %>%
  mutate(
    group = row_number(),
    x1 = 0 + ((1 - n)/2),
    x4 = n + ((1 - n)/2),
    x2 = lag(x1), 
    x3 = lag(x4)) %>%
  mutate(
    x2 = ifelse(is.na(x2), x1, x2),
    x3 = ifelse(is.na(x3), x4, x3)
  ) %>%
  gather(xpoint, x, -step_names,-group, -n) %>%
  arrange(group, xpoint) %>%
  mutate(y = ifelse(xpoint %in% c("x2", "x3"), group, group + 1))


# EXAMPLE
# Create the placement of the stages in the plot,
#  by just adding a 0.5 to each row number


labels <- orig %>%
  arrange(n) %>%
  mutate(y = row_number() + 0.5)

# modify the labels
labels$step_names2 <- c( "EXCLUDE,\nconference proceedings,\nretracted papers",
                         "EXCLUDE CATEGORIES (NOT\nbiotechnology, applied\nmicrobiology, oncology\nhaematology,\nengineering biomedical)",
                         "REFINE BY SOURCE TITLES\n(EXCLUDE NOT clinical/\ntranslation/regenerative,\nmedicine)",
                         "REFINE BY CATEGORY\ncell tissue engineering\nand transplantation",
                         "REFINE BY DOCUMENT\nTYPE article",
                         "mesenchymal stem cells OR\nmesenchymal stromal cells\nOR MSC AND characterisation,\nAND clinical")

# read data for 1B
fig1b <- read.table("data/fig1b.txt", header = TRUE)

```


### each panel of fig 1
```{r fig1}
# figure 1 a
article_funnel <- to_poly_orig %>%
  ggplot() +
  geom_polygon(aes(x,
                   y,
                   group = group,
                   fill = step_names),
               size = 0) +
  geom_label(aes(x = 0,
                y = y,
                label = n),
            data = labels, 
            size = 3,
            label.size = 0,
            label.padding = unit(0.1, "lines"),
            label.r = unit(0.1, "lines")) +
  scale_y_continuous(breaks = labels$y,
                     labels = labels$step_names2) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y  = element_text(size = 7, colour = "black", hjust = 0, face = "plain"),
        panel.spacing = unit(0, "lines"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank()) +
    scale_fill_manual(values = rev(pal))


# fig 1b

data_collection <- fig1b %>% 
  ggplot() +
  geom_text(aes(x = x, y = y, label = item),
            size = 2.5,nudge_y = 0.1,
            hjust = "left") +
  facet_grid(. ~ data_element) +
  scale_x_continuous(limits = c(0, 7)) +
  theme_minimal() +
  theme(legend.position = "none",
        strip.text = element_text(hjust = 0, size = 5.5, colour = "white", face = "bold"),
        strip.background = element_rect(fill = pal[1], colour = pal[1], size = 0.05),
        panel.border = element_rect(colour = "black", fill = NA),
        panel.spacing = unit(0, "lines"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 
  




```


### whole fig 1
```{r fig1}

layout <- "
#aaaaaaaaaaaaaaaaaaa
#aaaaaaaaaaaaaaaaaaa
#aaaaaaaaaaaaaaaaaaa
#aaaaaaaaaaaaaaaaaaa
#aaaaaaaaaaaaaaaaaaa
#aaaaaaaaaaaaaaaaaaa
#aaaaaaaaaaaaaaaaaaa
bbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbb
"


fig1 <- article_funnel + data_collection + 
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "A")&
    theme(plot.tag = element_text(size = 9, hjust = 1, face = "bold"))


ggsave("figs/fig_1.svg", 
       plot = fig1, 
       device = device,
       width = fig_w, 
       height = fig_h*1.6,
       units = units)

```


## Fig 2 - Articles by country, phase, indications, route of admin

### prep

```{r fig2-prep}
# by country A
summary_country <- dat %>%
  group_by(country) %>% 
  summarise(n = length(country))

# phase B
summary_phase <- dat %>%
  group_by(phase) %>% 
  summarise(n = length(phase),
            pc = paste0(round(100 * n / 84, 1 ), "%"))

summary_phase_condensed <- dat %>%
  group_by(phase_condensed) %>% 
  summarise(n = length(phase_condensed),
            pc = paste0(round(100 * n / 84, 1 ), "%"))

# indication C
summary_indication <- dat %>%
  group_by(indication) %>% 
  summarise(n = length(indication),
            pc = paste0(round(100 * n / 84, 1 ), "%"))

# route D
summary_route <- dat %>%
  group_by(route) %>% 
  summarise(n = length(route),
            pc = paste0(round(100 * n / 84, 1 ), "%"))

```


### each panel figure 2
```{r fig2}
#by country
country_bar <- summary_country %>% 
  ggplot(aes(x = reorder(country, n), y = n)) +
  geom_bar(stat = "identity", 
           # fill = pal[4],
           fill = "black",
           size = 0, width = 0.8) +
  xlab("") +
  scale_y_continuous(name = NULL, 
                     breaks = seq(0, 15, 5),
                     minor_breaks = seq(0, 15, 1),
                     limits = c(0, 16),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4)) +
  coord_flip()

  
# by phase
phase_bar <- summary_phase %>% 
  ggplot(aes(x = reorder(phase,n), y = n)) +
  geom_bar(stat = "identity", 
           # fill = pal[4],
           fill = "black",
           size = 0, 
           width = 0.8) +
  xlab("") +
 # geom_text(aes(y = n + 4, label = pc) ) +
  scale_y_continuous(name = NULL, 
                     breaks = seq(0, 35, 10),
                     minor_breaks = seq(0, 35, 1),
                     limits = c(0, 35),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4)) +
  coord_flip()

# by indication
indication_bar <- summary_indication %>% 
  ggplot(aes(x = reorder(indication, n), y = n)) +
  geom_bar(stat = "identity", 
           # fill = pal[4], 
           fill = "black", 
           size = 0, 
           width = 0.8) +
  xlab("") +
  scale_y_continuous(name = NULL, 
                     breaks = seq(0, 12, 2),
                     minor_breaks = seq(0, 12, 2),
                     limits = c(0, 13),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4)) +
  coord_flip()

# by route
route_bar <- summary_route %>% 
  ggplot(aes(x = reorder(route, n), y = n)) +
  geom_bar(stat = "identity", 
           # fill = pal[4],
            fill = "black",
           size = 0, 
           width = 0.8) +
  xlab("") +
#  geom_text(aes(y = n + 3, label = pc) ) +
  scale_y_continuous(name = NULL, 
                     breaks = seq(0, 25, 5),
                     minor_breaks = seq(0, 25, 1),
                     limits = c(0, 25),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4)) +
  coord_flip()

```

### whole fig 2
```{r fig2-layout}

layout <- "
a#
a#
ad
ad
ad
ad
ad
bd
bd
bd
cd
cd
cd
cd
"


fig2 <- country_bar + phase_bar + route_bar + indication_bar +
  plot_layout(design = layout) +
  plot_annotation(caption = "Number of Articles",
                  tag_levels = "A")&
    theme(plot.tag = element_text(size = 9, hjust = 0, face = "bold"),
          plot.caption = element_text(size = 9, hjust = 0.5, face = "plain"))


ggsave("figs/fig_2_black.svg", 
       plot = fig2, 
       device = device,
       width = fig_w_2, 
       height = fig_h*2,
       units = units)

```

## Fig 3 - Articles by sources, allo/auto stem/stromal

### prep


```{r fig3_prep}
# source 3a
summary_source <- dat %>% 
  group_by(source) %>% 
  summarise(n = length(source),
            pc = paste0(round(100 * n / 84, 1 ), "%"))


# allo va auto 3b
summary_allo_auto <- dat %>% 
  group_by(allo_auto) %>% 
  summarise(n = length(allo_auto),
            pc = paste0(round(100 * n / 84, 1 ), "%"))


# stem vs stromal 3b
summary_stem_stromal <- dat %>% 
  group_by(stem_stromal) %>% 
  summarise(n = length(stem_stromal),
            pc = paste0(round(100 * n / 84, 1 ), "%"))
```
### each panel figure 2

```{r fig_3}
# source
source_bar <- summary_source %>% 
  ggplot(aes(x = source, y = n)) +
  geom_bar(stat = "identity",
           # fill = pal[4],
           fill = "black",
           size = 0, 
           width = 0.8) +
  scale_y_continuous(name = "Number of Articles",
                    breaks = seq(0, 50, 10),
                    minor_breaks = seq(0, 50, 10),
                    limits = c(0, 60),
                    expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = NULL) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black",
                                  angle = 285, vjust = 0.5, hjust = 0),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())

# allo - auto
allo_auto_bar <- summary_allo_auto %>% 
  ggplot(aes(x = allo_auto, y = n)) +
  geom_bar(stat = "identity",
           # fill = pal[4], 
           fill = "black",
           size = 0, 
           width = 0.8) +
  scale_y_continuous(name = NULL,
                    breaks = seq(0, 50, 10),
                    minor_breaks = seq(0, 50, 10),
                    limits = c(0, 60),
                    expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = NULL) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black", 
                                  angle = 285, vjust = 0.5, hjust = 0),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())



# stem_stomal
stem_stromal_bar <- summary_stem_stromal %>%
  ggplot(aes(x = stem_stromal, y = n)) +
  geom_bar(stat = "identity",
           # fill = pal[4], 
           fill = "black",
           size = 0, 
           width = 0.8) +
  scale_y_continuous(name = NULL,
                    breaks = seq(0, 50, 10),
                    minor_breaks = seq(0, 50, 10),
                    limits = c(0, 60),
                    expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = NULL) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black", 
                                   angle = 285, vjust = 0.5, hjust = 0),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())
```


### whole fig 3
```{r fig_3-layout}
layout <- "
aaabbbcccc
"


fig3 <- source_bar  + allo_auto_bar+ stem_stromal_bar +
  plot_layout(design = layout) +
  plot_annotation(caption = "Source",
                  tag_levels = "A")&
    theme(plot.tag = element_text(size = 9, hjust = 0, face = "bold"),
          plot.caption = element_text(size = 9, hjust = 0.5, vjust = 1, face = "plain"))


ggsave("figs/fig_3_black.svg", 
       plot = fig3, 
       device = device,
       width = fig_w_1.5, 
       height = fig_h,
       units = units)
```

## Fig 4 - characterisation by article

### prep


```{r fig4_prep}
# test stringency
summary_test <- dat %>% 
  group_by(test_results) %>% 
  summarise(n = length(test_results),
            pc = paste0(round(100 * n / 84, 1 ), "%"))
# phase by stringency
summary_phase_test <- dat %>%
  group_by(phase_condensed, test_results) %>% 
  summarise(n = length(phase_condensed))

# number of markers reported in articles either reporting % by batch of average percentages (p)
summary_marker_p_count <- dat %>% 
  filter(test_results != "3. Tests done but % not reported") %>%
  filter(test_results != "4. Stated as 'standard phenotype'") %>%
  filter(test_results != "5. No characterisation discussed") %>%
  group_by(marker_p_count) %>% 
  summarise(n = length(marker_p_count))

```
### each panel figure 4

```{r fig_4}
# test stringency overall
test_bar <- summary_test %>% 
  ggplot(aes(x = test_results, y = n, fill = test_results)) +
  geom_bar(stat = "identity", size = 0) +
  xlab("") +
  geom_text(aes(y = n + 6, label = pc), size = 3 ) +
  scale_fill_manual(values = rev(pal[1:5]),
                    name = "Test results") +
  scale_y_continuous(name = "Number of Articles", 
                     breaks = seq(0, 50, 5),
                     minor_breaks = seq(0, 50, 1),
                     limits = c(0, 53),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), ) +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none") +
  coord_flip()

# tests stringency by phase
phase_test <- summary_phase_test %>% 
  ggplot(aes(x = phase_condensed, y = n, fill = test_results)) +
  geom_bar(stat = "identity", size = 0, width = 0.8) +
  scale_fill_manual(values = pal,
                    name = NULL) +
  scale_y_continuous(name = "Number of Articles",
                     breaks = seq(0, 55, 10),
                     minor_breaks = seq(0, 55, 5),
                     limits = c(0, 55),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = "Phase") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none") 


# 
markerp_bar <- summary_marker_p_count %>% 
  ggplot(aes(x = marker_p_count, y = n)) +
  geom_bar(stat = "identity", fill = pal[6], size = 0, width = 0.8) +
  scale_y_continuous(name = NULL, 
                     breaks = seq(0, 12, 2),
                     minor_breaks = seq(0, 12, 2),
                     limits = c(0, 12),
                     expand = c(0, 0)) +
  scale_x_continuous(name = "Number of markers",
                     breaks = seq(0, 11, 1),
                    minor_breaks = seq(0, 12, 2),
                    limits = c(0.5, 12),
                     expand = c(0, 0)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank()) 

```


### whole fig 4
```{r fig_4-layout}
layout <- "
#aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
bbbcccccccccccccccccccccccccccccccccccc
"

layout <- "
aaaaaabbbcccc
"

fig4 <- test_bar + phase_test + markerp_bar +
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "A")&
    theme(plot.tag = element_text(size = 9, hjust = 0, face = "bold"))


ggsave("figs/fig_4.svg", 
       plot = fig4, 
       device = device,
       width = fig_w_2, 
       height = 2.2,
       units = units)
```


## Fig 5 - Characterisation detail

### prep

```{r}

# select the test columns and count the number of articles for each marker and category
test_cols <- names(select(dat, ends_with("_test")))

test_by_attribute <- dat %>% 
  select(test_cols, ref_number) %>% 
  pivot_longer(cols = -ref_number, 
               names_to = "marker", 
               values_to = "status")

# process the names to remove _test

test_by_attribute <- test_by_attribute %>% 
  mutate(marker2 = str_replace(marker, "_test", ""))

# change levels of status and markers.
# markers
# process test_col names
test_cols <- str_replace(test_cols, "_test", "")
# set the levels in that order
test_by_attribute$marker2 <- factor(test_by_attribute$marker2, 
                                    levels = test_cols)
test_by_attribute$ref_number <- factor(test_by_attribute$ref_number)
# status
# recode status
test_by_attribute <- test_by_attribute %>%
  mutate(test_status = recode_factor(status,
                                     p = "Performed, value reported (by batch or average)",
                                     m = "Performed, no value reported",
                                     n = "Not performed"))

test_by_attribute$test_status <- fct_relevel(test_by_attribute$test_status,
                                             "Not performed",
                                             "Performed, no value reported",
                                             "Performed, value reported (by batch or average)")
test_by_attribute <- test_by_attribute %>% 
  select(ref_number, marker2, test_status)

# test_by_attribute$n <- 1

# create the summary row & column
# test_by_attribute_aug <- bind_rows(
#   test_by_attribute,
#   test_by_attribute %>% 
#     filter(test_status == "Performed, value reported (by batch or average)") %>% 
#     group_by(ref_number, .drop = FALSE) %>% 
#     summarize(
#       n = sum(n),
#       marker2 = "Total P",
#       test_status = "Performed, value reported (by batch or average)"
  #   ),
  # test_by_attribute %>% 
  #   filter(test_status == "Performed, value reported (by batch or average)") %>% 
  #   group_by(marker2, .drop = FALSE) %>% 
  #   summarize(
  #     n = sum(n),
  #     ref_number = "Total P",
  #     test_status = "Performed, value reported (by batch or average)"
#     )
# )
# 
# test_by_attribute_aug <- bind_rows(
#   test_by_attribute_aug,
#   test_by_attribute %>% 
#     filter(test_status == "Performed, no value reported") %>% 
#     group_by(ref_number, .drop = FALSE) %>% 
#     summarize(
#       n = sum(n),
#       marker2 = "Total M",
#       test_status = "Performed, no value reported"
  #   ),
  # test_by_attribute %>% 
  #   filter(test_status == "Performed, no value reported") %>% 
  #   group_by(marker2, .drop = FALSE) %>% 
  #   summarize(
  #     n = sum(n),
  #     ref_number = "Total M",
  #     test_status = "Performed, no value reported"
#     )
# )





# test_by_attribute_aug$marker2 <- factor(test_by_attribute_aug$marker2, 
#                                     levels = c(test_cols, "Total P", "Total M"))
# test_by_attribute_aug$ref_number <- factor(test_by_attribute_aug$ref_number, 
#                                     levels = levels(test_by_attribute$ref_number))

test_by_attribute_summary <- test_by_attribute %>% 
  group_by(marker2, test_status) %>% 
  summarise(n = length(marker2))

isct_pos <- c("CD73", "CD90", "CD105")
isct_neg <- c("CD34", "CD45", "CD11b", "CD14", "CD79a", "CD19", "HLA-DR")
isct_not <- c("viability",  "CD3" ,"CD13", "CD31", "CD133", "CD166", "CD29", "CD44", "CD146", "CD271", "STRO-1", "MSCA-1", "SSEA-4")
  
test_by_attribute <- test_by_attribute %>%
    mutate(ISCT = case_when(marker2 %in% isct_pos ~ "+",
                            marker2 %in% isct_neg ~ "–",
                            marker2 %in% isct_not ~ ""))
test_by_attribute_summary <- test_by_attribute_summary %>%
    mutate(ISCT = case_when(marker2 %in% isct_pos ~ "+",
                            marker2 %in% isct_neg ~ "–",
                            marker2 %in% isct_not ~ ""))
codes <- data.frame(marker2 = test_cols)
codes <- codes %>%
  mutate(ISCT = case_when(marker2 %in% isct_pos ~ "+",
                          marker2 %in% isct_neg ~ "–",
                          marker2 %in% isct_not ~ ""))
test_by_attribute$ref_number <- as.numeric(as.character(test_by_attribute$ref_number))
```

### each panel in figure 5

```{r}

# create the plot
# fig5 <- test_by_attribute_aug %>% 
#   ggplot() + 
#   geom_tile(aes(x = marker2, y = ref_number, fill = test_status), colour = "white") + 
#   scale_fill_manual(values =  c("#BABABA", pal[c(3, 5)]),
#                     name = "Test results",
#                     guide = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5 )) +
#   scale_x_discrete(name = "Characterisation attribute",
#                      expand = c(0.02, 0)) +
#   scale_y_discrete(expand = c(0, 0), name = "Reference") +
#   geom_text(data = filter(test_by_attribute_aug, marker2 == 'Total P' | ref_number == 'Total P'| marker2 == 'Total M' | ref_number == 'Total M'), 
#              aes(x = marker2, y = ref_number, label = n), size = 3, face = "bold") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(size = 8, colour = "black",
#                                    angle = 300, hjust = 0, vjust = 0.3),
#         axis.text.y  = element_text(size = 8, colour = "black"),
#         panel.grid.major.x = element_blank(),
#         panel.grid.minor.x = element_blank(),
#         panel.grid.minor.y = element_blank(),
#         legend.position = "top",
#         legend.text = element_text(size = 8, colour = "black"),
#         legend.key.size = unit(0.2, "in"))




# fig5 <- test_by_attribute_aug %>% 
#   ggplot() + 
#   geom_tile(aes(x = ref_number, y = marker2, fill = test_status), colour = "white") + 
#   scale_fill_manual(values =  c("#BABABA", pal[c(3, 5)]),
#                     name = "Test results",
                    # guide = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5 )) +
#   scale_x_discrete(name = "Reference",
#                      expand = c(0.02, 0)) +
#   scale_y_discrete(expand = c(0, 0), name = "Characterisation attribute" ) +
#   geom_text(data = filter(test_by_attribute_aug, marker2 == 'Total P' | ref_number == 'Total P'| marker2 == 'Total M' | ref_number == 'Total M'), 
#              aes(x = ref_number, y = marker2,  label = n), size = 3, face = "bold") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(size = 8, colour = "black",
#                                    angle = 300, hjust = 0, vjust = 0.3),
#         axis.text.y  = element_text(size = 8, colour = "black"),
#         panel.grid.major.x = element_blank(),
#         panel.grid.minor.x = element_blank(),
#         panel.grid.minor.y = element_blank(),
#         legend.position = "top",
#         legend.text = element_text(size = 8, colour = "black"),
#         legend.key.size = unit(0.2, "in"))



fig5a <- test_by_attribute %>% 
  ggplot() + 
  geom_tile(aes(x = ref_number, y = marker2, fill = test_status), colour = "white") + 
  scale_fill_manual(values =  c("#BABABA", pal[c(3, 5)]),
                    name = "Test results",
                    guide = guide_legend(nrow = 3)) +
  scale_x_continuous(name = "Reference",
                     breaks = seq(0, 84, 5),
                     minor_breaks = seq(0, 84, 5),
                     limits = c(1, 87),
                     expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0), name = "Characterisation attribute") +
  # geom_text(aes(x = 85, y = marker2 , label = ISCT),
  #           size = 2,
  #           face = "bold") +
  # coord_cartesian(xlim = c(0, 84), # This focuses the x-axis on the range of interest
  #                 clip = 'off') +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 8, colour = "black", hjust = 0.5,),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
         legend.position = "top",
        legend.title = element_blank(),
        legend.text = element_text(size = 8, colour = "black"),
        legend.key.size = unit(0.1, "in"))


fig5b <- test_by_attribute_summary %>% 
  ggplot() +
  geom_bar(aes(x = n, y = marker2, fill = test_status),
           stat = "identity", width = 0.8, size = 0) +
  scale_fill_manual(values =  c("#BABABA", pal[c(3, 5)])) +
  scale_x_continuous(name = "Number of Articles",
                     breaks = seq(0, 90, 10),
                     minor_breaks = seq(0, 90, 10),
                     limits = c(0, 85),
                     expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0.5), name = NULL, labels = codes$ISCT) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 10, colour = "black",
                                    face = "bold", vjust = 0.3),
        axis.ticks.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.position = "none")



```

### the whole figure 5


```{r}

layout <- "
aaab
"

fig5 <- fig5a +fig5b &
  plot_layout(design = layout) &
  plot_annotation(tag_levels = "A")&
  geom_hline(yintercept = 1.5) &
   geom_hline(yintercept = 11.5) &
    theme(plot.tag = element_text(size = 9, hjust = 0, face = "bold"),
          plot.margin = margin(0,0,0,0))



ggsave("figs/fig_5.svg", 
       plot = fig5, 
       device = device,
       width = fig_w_2, 
       height = fig_h * 1.2,
       units = units)
```





## Fig 6 - functionality assessments

### prep

```{r}
# panel a
functionality <- dat %>% 
  select(O, A, C, other) %>% 
  pivot_longer(cols = everything(), names_to = "type", values_to = "status") %>% 
  group_by(type, status) %>% 
  summarise(n = length(status),
            pc = paste0(round(100 * n / 84, 1 ), "%")) %>% 
  ungroup(type, status)

# status
# relevel status
functionality$status <- fct_relevel(functionality$status,
                                    "Not mentioned",
                                    "Performed, no value reported",
                                    "Performed, value reported")

# recode functionality
functionality <- functionality %>%
  mutate(type = recode_factor(type,
                              other = "Other functionality",
                              C = "Chondrogenesis",
                              A = "Adipogenesis",
                              O = "Osteogenesis"))

functionality$type <- fct_relevel(functionality$type,
                                         "Other functionality",
                                         "Chondrogenesis",
                                         "Adipogenesis",
                                         "Osteogenesis")

# panel b
moa_isct_summary <- dat %>% 
  group_by(MOA, stem_stromal) %>% 
  summarise(n = length(MOA),
            pc = paste0(round(100 * n / 84, 1 ), "%"))

moa_isct_summary$stem_stromal <- fct_relevel(moa_isct_summary$stem_stromal,
                                         "Stem",
                                         "Stromal",
                                         "Multipotent Stromal",
                                         "Regenerative")

moa_isct_summary$MOA <- fct_relevel(moa_isct_summary$MOA,
                                    "Not stated",
                                    "Multiple",
                                    "Differentiation",
                                    "Immune",
                                    "Paracrine")



# panel c
diffmoasum <- dat %>% group_by(MOA, differentiation) %>% 
  summarise(n = length(differentiation))

diffmoasum$MOA <- fct_relevel(diffmoasum$MOA,
                                     "Not stated",
                                    "Multiple",
                                    "Differentiation",
                                    "Immune",
                                    "Paracrine")

diffmoasum$differentiation <- fct_relevel(diffmoasum$differentiation,
                                          "No",
                                          "Yes")

```



### each panel figure 6

```{r}
# panel a
fig6a <- functionality %>% 
  ggplot() +
  geom_bar(aes(x = type, y = n, fill = status, label = pc),
           stat = "identity", size = 0) +
  scale_fill_manual(values =  c("#BABABA", pal[c(3, 5)]),
                    name = " Functionality",
                    guide = guide_legend(nrow = 4,
                                         title.position = "top",
                                         title.hjust = 0 )) +
  scale_y_continuous(name = "Number of Articles",
                     breaks = seq(0, 80, 10),
                     minor_breaks = seq(0, 80, 10),
                     limits = c(0, 85),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0.5), name = NULL) +
  geom_text(data = filter(functionality, 
                          status == "Not mentioned"),
            aes(x = type, 50, label = pc) ) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        plot.margin = margin(t = 0, r = 30),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 8, colour = "black"),
        legend.key.size = unit(0.1, "in")) +
  coord_flip()

# panel b
fig6b <- moa_isct_summary %>% 
  ggplot(aes(x = MOA, y = n, fill = stem_stromal)) +
  geom_bar(stat = "identity", size = 0) +
  scale_fill_manual(values = pal, 
                    name = "Nomenclature",
                    guide = guide_legend(nrow = 4,
                                         title.position = "top",
                                         title.hjust = 0 )) +
  scale_y_continuous(name = "Number of Articles", 
                     breaks = seq(0, 40, 5),
                     minor_breaks = seq(0, 40, 5),
                     limits = c(0, 42),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = "MOA") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        plot.margin = margin(t = 0, r = 0, l = 0),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 8, colour = "black"),
        legend.key.size = unit(0.1, "in")) +
  coord_flip()

# panel c
fig6c <- diffmoasum %>%
  ggplot(aes(x = MOA, y = n, fill = differentiation)) +
  geom_bar(stat = "identity", size = 0) +
   scale_fill_manual(values = c("#BABABA", pal[5]), 
                    name = "Differentiation capacity",
                    labels = c("Not demonstrated", "Demonstrated"),
                    guide = guide_legend(nrow = 4, 
                                         title.position = "top",
                                         title.hjust = 0)) +
  scale_y_continuous(name = "Number of Articles", 
                     breaks = seq(0, 40, 5),
                     minor_breaks = seq(0, 40, 5),
                     limits = c(0, 42),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = NULL, labels =NULL) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        plot.margin = margin(t = 0, r = 0, l = 0),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "top",
        legend.text = element_text(size = 8, colour = "black"),
        legend.key.size = unit(0.1, "in")) +
  coord_flip()

```

### the whole figure 6


```{r}

layout <- "
abc
"

fig6 <- fig6a + fig6b + fig6c +
  plot_layout(design = layout) +
  plot_annotation(tag_levels = "A")&
    theme(plot.tag = element_text(size = 9, hjust = 0, face = "bold"))
ggsave("figs/fig_6.svg", 
       plot = fig6, 
       device = device,
       width = fig_w_2, 
       height = 3,
       units = units)

```


## Relationship between MOA and stem/stromal

```{r}
res <- table(dat$stem_stromal, dat$MOA) %>%
  fisher.test(simulate.p.value = TRUE)
test_anno <- paste0("There is no significant association between MOA and cell categorisation\n(",
                   res$method, ": p = ", round(res$p.value, 3))

```


## Figure 10 assocation between differentiation2 and MOA

```{r}
res <- table(dat$differentiation_2, dat$MOA) %>% fisher.test(simulate.p.value = TRUE)
chisq.test(table(dat$differentiation_2, dat$MOA))$exp;table(dat$differentiation_2, dat$MOA)
test_anno <- paste0("There is  significant association between MOA and demonstration of differentiation capacity(", res$method, ": p = ", round(res$p.value, 3),") with more studies demonstrating differentiation for Immune MOA, and fewer for Paracrine and Multiple MOA than expected.")
```
# CD values figures

```{r}
cd_dat_summary <- cd_dat %>% 
  group_by(Ref, marker) %>% 
  summarise(mean_value = mean(value),
            n = length(value),
            se_value = sd(value)/sqrt(n))
str(cd_dat_summary)
# length(unique(cd_dat$marker)) *length(unique(cd_dat$Ref))

# bind the range and the sinlge value dataframes
cd_dat_summary <- rbind(data.frame(cd_dat_summary), cd_dat2)

```


```{r}
# count the number of refs that have values
cd_refs_by_marker <- cd_dat_summary %>% 
  group_by(marker) %>%
  summarise(n_refs = length(mean_value[!is.na(mean_value)]))

cd_refs_by_marker$marker
isct <- c("Viability","CD73", "CD90", "CD105", "CD34", "CD45" , "CD11b", "CD14" , "CD79α", "CD19", "HLA-DR")
cd_refs_by_marker$ISCT <- "Other marker"
cd_refs_by_marker$ISCT[cd_refs_by_marker$marker %in% isct] <- "ISCT phenotype marker"

cd_refs_by_marker$ISCT <- fct_relevel(cd_refs_by_marker$ISCT,
                              "ISCT phenotype marker",
                              "Other marker")

```


```{r cd-refs-bar}
cd_refs_bar <- cd_refs_by_marker %>% 
  arrange(ISCT, n_refs) %>%
         mutate(marker = factor(marker, levels = marker) ) %>% 
  ggplot(aes(x = reorder(marker, ISCT), y = n_refs, fill = ISCT )) +
  geom_bar(stat = "identity",  size = 0) +
  xlab("") +
  scale_y_continuous(name = "Number of Articles", 
                     breaks = seq(0, 15, 1),
                     minor_breaks = seq(0, 15, 1),
                     limits = c(0, 15),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_fill_manual(values = pal[c(5, 2)], 
                    name = NULL) +
  labs(title = "Wilson, Alison, Figure X3. TOP" ) +
  annotate("segment", x = 0.5, xend = 10.5, 
           y = 14, yend = 14,
           colour = "black", size = 1) +
  annotate("segment", x = 0.58, xend = 0.58, 
           y = 14, yend = 13.5,
           colour = "black", size = 1) +
  annotate("segment", x = 10.38, xend = 10.38, 
           y = 14, yend = 13.5,
           colour = "black", size = 1) +
  annotate("text", x = 3,  y = 10, 
           label = "ISCT phenotype\nmarker", size = 4) +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        # legend.title = element_text(size = 8, colour = "black"),
        # legend.text = element_text(size = 8, colour = "black"),
        # legend.key.size = unit(0.2, "in"),
        # legend.position = c(0.7, 0.8),
        legend.position = "none",
        plot.title = element_text(hjust = 0, size = 4)) +
  coord_flip()

ggsave("figs/fig_x3_cd_refs_bar.svg", 
       plot = cd_refs_bar, 
       device = device,
       width = fig_w, 
       height = fig_w,
       units = units,
       dpi = dpi)

```

```{r}

cd_dat_summary_values <- cd_dat_summary %>% 
  filter(!is.na(mean_value))

cd_dat_summary_values$ISCT <- "Other marker"
cd_dat_summary_values$ISCT[cd_dat_summary_values$marker %in% isct] <- "ISCT phenotype marker"

cd_dat_summary_values$ISCT <- fct_relevel(cd_dat_summary_values$ISCT,
                              "ISCT phenotype marker",
                              "Other marker")
```

```{r}
cd_values_point_isct <- cd_dat_summary_values %>% 
  filter(ISCT == "ISCT phenotype marker") %>% 
  ggplot(aes(x = marker, y = mean_value)) +
  geom_pointrange(aes(ymin = mean_value - se_value, ymax = mean_value + se_value), 
                  position = position_jitter(width = 0.5), shape = 20) +
  xlab("") +
  scale_y_continuous(name = "Value reported", 
                     breaks = seq(0, 110, 10),
                     minor_breaks = seq(0, 110, 10),
                     limits = c(0, 110),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  labs(title = "Wilson, Alison, Figure X4. TOP" ) +
  geom_vline(xintercept = seq(1.5, 10.5, 1), linetype = "longdash") +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        # legend.title = element_text(size = 8, colour = "black"),
        # legend.text = element_text(size = 8, colour = "black"),
        # legend.key.size = unit(0.2, "in"),
        # legend.position = c(0.7, 0.8),
        legend.position = "none",
        plot.title = element_text(hjust = 0, size = 4))
ggsave("figs/fig_x4_cd_values_isct.svg", 
       plot = cd_values_point_isct, 
       device = device,
       width = fig_w_1.5, 
       height = fig_w,
       units = units,
       dpi = dpi)

```
 
```{r}
cd_values_point_other <- cd_dat_summary_values %>% 
  filter(ISCT == "Other marker") %>% 
  ggplot(aes(x = marker, y = mean_value)) +
  geom_pointrange(aes(ymin = mean_value - se_value, ymax = mean_value + se_value), 
                  position = position_jitter(width = 0.5), shape = 20) +
  xlab("") +
  scale_y_continuous(name = "Value reported", 
                     breaks = seq(0, 110, 10),
                     minor_breaks = seq(0, 110, 10),
                     limits = c(0, 110),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  labs(title = "Wilson, Alison, Figure X4. TOP" ) +
  geom_vline(xintercept = seq(1.5, 10.5, 1), linetype = "longdash") +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        # legend.title = element_text(size = 8, colour = "black"),
        # legend.text = element_text(size = 8, colour = "black"),
        # legend.key.size = unit(0.2, "in"),
        # legend.position = c(0.7, 0.8),
        legend.position = "none",
        plot.title = element_text(hjust = 0, size = 4))
ggsave("figs/fig_x5_cd_values_isct.svg", 
       plot = cd_values_point_other, 
       device = device,
       width = fig_w_1.5, 
       height = fig_w,
       units = units,
       dpi = dpi)

```

```{r}


# disease targets
dat %>% group_by(Indication) %>% 
  summarise(n = length(Indication)) %>% 
  ggplot(aes(x = Indication, y = n)) +
  geom_bar(stat="identity")




```
















