---
title: 'Characterisation of MSC in clinical trial reports: analysis of published descriptors'
author: "Emma Rand"
date: "16/01/2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

# Figures specification
* titled
* cited in numerical order in the text using Arabic numbers. 
* no additional charges for color. 
* submitted as individual files
* labeled with the Corresponding Author name, the appropriate figure number, and  orientation (e.g., “top”)
* Figures may be submitted as multipart panels.
*  *.tif* or .eps 
* final publication size; 1-column width or, if necessary, 1½ column width. The  2-column width should not be used unless necessary.
* 1.0 column = 3.2 Inches, 8.2 Centimeters, 19.25 Picas
* 1.5 column = 4.5 Inches, 11.4 Centimeters, 27.00 Picas
* 2.0 column = 5.8 Inches, 14.8 Centimeters, 35.00 Picas
* height of all figures <= to 9.6inches / 24.5 cm / 58 picas.
* Calibri font sub sans serif Arial
* Multipanel labeled using uppercase 12-point Calibri Bold. 
* minimum text size of 6 points
* bold enough to be easily read after reduction, as should all symbols used in the * figure. Line or bar graphs or flow charts with text should be created in black and white, not shades of gray, which are difficult to reproduce in even tones. If more than two sets of data are represented, use of fill patterns or colors (not gray) is suggested to present the data clearly.
* Minimum resolution is 300 dpi for color and grayscale figures, 600 dpi for  combination halftones, and 1000 dpi for line art.



```{r pkg}
library(tidyverse)
# library(readxl)
# library(kableExtra)
library(tiff)
library(grid)
library(patchwork)
library(janitor)

```

```{r}

# palette
pal <- viridisLite::viridis(6)

# figure saving settings
units = "in"
fig_w <- 3.2
fig_w_1.5 <- 4.5
fig_w_2 <- 5.8
fig_h <- 4.5
fig_h_1.5 <- 4.5 * 1.5
dpi <- 600
device <- "tiff"

```

## write to file
```{r}
# file <- "data/checked_processed_aw_corrections.csv"
# write_csv(dat, file)
```


# Read in the processed and corrected data

```{r}
file <- "data/checked_processed_aw_corrections.csv"
dat <- read_csv(file, skip = 1)
# write(names(dat), "data/varnames.txt")

```


```{r}
# put levels in
source("levels.R")
```

# Figures

## Fig 1 - Article search funnel

```{r data-prep-fig1}
# create data
# short names for proof of method
orig <- data.frame(step_names = c("1.mesenchymal",
                                  "2.article",
                                  "3.cell tissue etc",
                                  "4.clinical etc",
                                  "5.not biotech etc",
                                  "6.exc conf etc"),
                   n = c(65706,
                         47031,
                         7814,
                         5502,
                         2055,
                         1986))

# prep polygons that connect
to_poly_orig <- orig %>%
  arrange(n) %>%
  mutate(
    group = row_number(),
    x1 = 0 + ((1 - n)/2),
    x4 = n + ((1 - n)/2),
    x2 = lag(x1), 
    x3 = lag(x4)) %>%
  mutate(
    x2 = ifelse(is.na(x2), x1, x2),
    x3 = ifelse(is.na(x3), x4, x3)
  ) %>%
  gather(xpoint, x, -step_names,-group, -n) %>%
  arrange(group, xpoint) %>%
  mutate(y = ifelse(xpoint %in% c("x2", "x3"), group, group + 1))


# EXAMPLE
# Create the placement of the stages in the plot,
#  by just adding a 0.5 to each row number


labels <- orig %>%
  arrange(n) %>%
  mutate(y = row_number() + 0.5)

# modify the labels
labels$step_names2 <- c( "EXCLUDE conference proceedings,\nretracted papers",
                         "EXCLUDE CATEGORIES (NOT\nbiotechnology applied microbiology oncology\nhaematology, engineering biomedical)",
                         "REFINE BY SOURCE TITLES\n(EXCLUDE NOT clinical/\ntranslation/regenerative medicine)",
                         "REFINE BY CATEGORY\ncell tissue engineering\nand transplantation",
                         "REFINE BY DOCUMENT TYPE\narticle",
                         "mesenchymal stem cells OR\nmesenchymal stromal cells OR\nMSC AND characterisation AND clinical")
```



```{r fig1}
article_funnel <- to_poly_orig %>%
  ggplot() +
  geom_polygon(aes(x,
                   y,
                   group = group,
                   fill = step_names),
               size = 0) +
  geom_label(aes(x = 0,
                y = y,
                label = n),
            data = labels, 
            size = 3,
            label.size = 0,
            label.padding = unit(0.1, "lines"),
            label.r = unit(0.1, "lines")) +
  scale_y_continuous(breaks = labels$y,
                     labels = labels$step_names2) +
  labs(title = "Wilson, Alison, Figure 1. TOP" ) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y  = element_text(size = 7, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4)) +
    scale_fill_manual(values = rev(pal))

ggsave("figs/fig_1_Article_search_funnel.tif", 
       plot = article_funnel, 
       device = device,
       width = fig_w, 
       height = 3.0,
       units = units,
       dpi = dpi)
```

## Figure 3 Articles by country

```{r country-prep}
summary_country <- dat %>%
  group_by(country) %>% 
  summarise(n = length(country))


```

```{r fig3-country-bar}
country_bar <- summary_country %>% 
  ggplot(aes(x = reorder(country, n), y = n)) +
  geom_bar(stat = "identity", fill = pal[3],
           size = 0) +
  xlab("") +
  scale_y_continuous(name = "Number of articles", 
                     breaks = seq(0, 16, 1),
                     minor_breaks = seq(0, 16, 1),
                     limits = c(0, 16),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  labs(title = "Wilson, Alison, Figure 3. TOP" ) +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 7, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 7, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4)) +
  coord_flip()
ggsave("figs/fig_3_Article_country.tif", 
       plot = country_bar, 
       device = device,
       width = fig_w, 
       height = fig_w,
       units = units,
       dpi = dpi)
  
```
## Figure 4 Articles by Phase

### Eight phase version

```{r phase-prep}

summary_phase <- dat %>%
  group_by(phase) %>% 
  summarise(n = length(phase),
            pc = paste0(round(100 * n / 84, 1 ), "%"))

summary_phase_condensed <- dat %>%
  group_by(phase_condensed) %>% 
  summarise(n = length(phase_condensed),
            pc = paste0(round(100 * n / 84, 1 ), "%"))

```

```{r fig4-phase}
phase_bar <- summary_phase %>% 
  ggplot(aes(x = reorder(phase,n), y = n)) +
  geom_bar(stat = "identity", fill = pal[3], size = 0) +
  xlab("") +
  geom_text(aes(y = n + 4, label = pc) ) +
  scale_y_continuous(name = "Number of Articles", 
                     breaks = seq(0, 45, 5),
                     minor_breaks = seq(0, 45, 1),
                     limits = c(0, 45),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  labs(title = "Wilson, Alison, Figure 4. TOP" ) +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4)) +
  coord_flip()

ggsave("figs/fig_4_Article_phase.tif", 
       plot = phase_bar, 
       device = device,
       width = fig_w, 
       height = fig_w,
       units = units,
       dpi = dpi)

```


## Figure 5 Articles by Source-Year


```{r source_year_prep}
summary_tissue <- dat %>% 
  group_by(source, year, 
           .drop = FALSE) %>% 
  summarise(n = length(source))
dat %>% 
  group_by(source, 
           .drop = FALSE) %>% 
  summarise(n =length(source), pc = n/84)

```



### stacked
```{r fig5-source-year-stack}
source_year <- summary_tissue %>% 
  ggplot(aes(x = year, y = n, fill = source)) +
  geom_bar(stat = "identity", size = 0) +
  scale_fill_manual(values = pal[c(1,3,5,6)],
                    guide = guide_legend(nrow = 3, title = NULL )) +
  scale_y_continuous(name = "Number of Articles",
                    breaks = seq(0, 20, 2),
                    minor_breaks = seq(0, 20, 2),
                    limits = c(0, 20),
                    expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = "Year") +
  labs(title = "Wilson, Alison, Figure 5. TOP" ) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4),
        legend.position = c(0.2, 0.9),
        legend.text = element_text(size = 6, colour = "black"),
        legend.key.size = unit(0.2, "in"))
       
ggsave("figs/fig_5_Article_source_year_stack.tif", 
       plot = source_year, 
       device = device,
       width = fig_w, 
       height = fig_w,
       units = units,
       dpi = dpi)

```


## Figure 6 - three panels


### panel 1: Articles by Test quality

```{r test-quality-prep}
summary_test <- dat %>% 
  group_by(test_results_2) %>% 
  summarise(n = length(test_results_2),
            pc = paste0(round(100 * n / 84, 1 ), "%"))


```

```{r testquality}
test_bar <- summary_test %>% 
  ggplot(aes(x = reorder(test_results_2, n), y = n, fill = test_results_2)) +
  geom_bar(stat = "identity", size = 0) +
  xlab("") +
  geom_text(aes(y = n + 6, label = pc) ) +
  scale_fill_manual(values = pal,
                    name = "Test results") +
  scale_y_continuous(name = "Number of Articles", 
                     breaks = seq(0, 50, 5),
                     minor_breaks = seq(0, 50, 1),
                     limits = c(0, 50),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0),
                   labels = c("Stated as 'standard\nphenotype' (s)",
                              "Phenotypic markers\nreported (y)",
                              "Tests done but\nnot reported (t)",
                              "Not discussed (o)",
                              "Average value (n)")) +
  labs(subtitle = "A") +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0, size = 4),
        plot.margin = margin(r = 0.1, b = 0.1, l = 0, unit="in")) +
  coord_flip()

# ggsave("figs/fig_6_Article_test_quality.tif", 
#        plot = test_bar, 
#        device = device,
#        width = fig_w, 
#        height = fig_w,
#        units = units,
#        dpi = dpi)

```

### panel 2 how many markers had average values  
```{r}
dat %>% 
  filter(test_results_2 != "Average value (n)") %>%
  filter(marker_count == 1) %>% 
  select(ref_number,test_results_2, test_results)


summary_marker_count <- dat %>% 
  filter(test_results_2 == "Average value (n)") %>%
  group_by(marker_count) %>% 
  summarise(n = length(marker_count))


```

```{r markercount}
marker_bar <- summary_marker_count %>% 
  ggplot(aes(x = factor(marker_count), y = n)) +
  geom_bar(stat = "identity", fill = pal[2], size = 0) +
  scale_y_continuous(name = "Number of\n'Average value (n)' Articles ", 
                     breaks = seq(0, 12, 2),
                     minor_breaks = seq(0, 12, 2),
                     limits = c(0, 12),
                     expand = c(0, 0)) +
  scale_x_discrete(name = "Number of markers\nreported by an article",
                   expand = c(0, 0)) +
  labs(subtitle = "B") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4),
        plot.margin = margin(r = 0.2, t = 0,l = 0, unit="in")) 
```


### panel 3  Articles by Phase and Test quality reported (previously fig7 a)

### Stacked by number of articles
```{r}

dat %>%
  group_by(phase_condensed) %>% 
  summarise(n = length(phase_condensed),
            pc = n/84)

summary_phase_test <- dat %>%
  group_by(phase_condensed, test_results_2) %>% 
  summarise(n = length(phase_condensed))
```

```{r phasetest}
phase_test <- summary_phase_test %>% 
  ggplot(aes(x = phase_condensed, y = n, fill = test_results_2)) +
  geom_bar(stat = "identity", size = 0) +
  scale_fill_manual(values = pal,
                    name = "Test results") +
  scale_y_continuous(name = "Number of Articles",
                     breaks = seq(0, 55, 10),
                     minor_breaks = seq(0, 55, 5),
                     limits = c(0, 55),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = "Phase") +
 labs(subtitle = "C") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 8),
        legend.position = "none", 
        plot.margin = margin(r = 0.3, l = 0.1, t = 0, unit="in")) 

```


```{r fig6}

layout <- "
aa
bc
"


fig6 <- test_bar + marker_bar + phase_test + 
  plot_layout(design = layout) +
  plot_annotation(title = "Wilson, Alison, Figure 6. TOP")&
    theme(text = element_text(size = 8, hjust = 0))


ggsave("figs/fig_6.tif", 
       plot = fig6, 
       device = device,
       width = fig_w_2, 
       height = fig_h,
       units = units,
       dpi = dpi)

```


## Figure 7 Characterisation by marker.
```{r}

# select the test columns and count the number of articles for each marker and category
test_cols <- names(select(dat, ends_with("_test")))

test_by_attribute <- dat %>% 
  select(test_cols, ref_number) %>% 
  pivot_longer(cols = -ref_number, 
               names_to = "marker", 
               values_to = "status")

# process the names to remove _test

test_by_attribute <- test_by_attribute %>% 
  mutate(marker2 = str_replace(marker, "_test", ""))

# change levels of status and markers.
# markers
# process test_col names
test_cols <- str_replace(test_cols, "_test", "")
# set the levels in that order
test_by_attribute$marker2 <- factor(charact_by_marker_ref$marker2, 
                                    levels = test_cols)

# status
# recode status
test_by_attribute <- test_by_attribute %>%
  mutate(test_status = recode_factor(status,
                                     p = "Performed, value reported",
                                     m = "Performed, no value reported",
                                     n = "Not mentioned"))

test_by_attribute$test_status <- fct_relevel(test_by_attribute$test_status,
                                             "Not mentioned",
                                             "Performed, no value reported",
                                             "Performed, value reported")


test_by_attribute_summary <- test_by_attribute %>% 
  group_by(marker2, test_status) %>% 
  summarise(n = length(marker2))


```

```{r}
fig7 <- test_by_attribute_summary %>% 
  ggplot() +
  geom_bar(aes(x = marker2, y = n, fill = test_status),
           stat = "identity", width = 0.6) +
  scale_fill_manual(values =  c("#BABABA", pal[c(2, 5)]),
                    name = "Test results",
                    guide = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5 )) +
  scale_y_continuous(name = "Number of Articles",
                     breaks = seq(0, 90, 10),
                     minor_breaks = seq(0, 90, 10),
                     limits = c(0, 90),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0.5), name = "Characterisation attribute") +
  geom_rect(xmin = 1.5, xmax = 11.5,
            ymin = -Inf, ymax = Inf,
            size = 1, linetype = 1, 
            colour = "black", alpha = 0) +
  labs(title = "Wilson, Alison, Figure 7. TOP" ) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 6, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4),
        legend.position = "top",
        legend.text = element_text(size = 8, colour = "black"),
        legend.key.size = unit(0.2, "in")) +
  coord_flip()
 
ggsave("figs/fig_7_charact_by_marker.tif", 
       plot = fig7, 
       device = device,
       width = fig_w_2, 
       height = fig_h,
       units = units,
       dpi = dpi)

```

# Possible alternative to Fig 7 (and 6b)
```{r}
#alt fig
fig7alt <- test_by_attribute %>% 
  ggplot() +
  geom_tile(aes(x = factor(ref_number), y = marker2 , fill = test_status),
            colour = "white")+
    scale_fill_manual(values =  c("#BABABA", pal[c(2, 5)]),
                    name = "Test results",
                    guide = guide_legend(nrow = 1, title.position = "top", title.hjust = 0.5 )) +
  scale_x_discrete(name = "Reference",
                     expand = c(0.01, 0)) +
  scale_y_discrete(expand = c(0, 0), name = "Characterisation attribute") +
  geom_rect(ymin = 1.5, ymax = 11.5,
            xmin = -Inf, xmax = Inf,
            size = 1, linetype = 1,
            colour = "black", alpha = 0) +
  labs(title = "Wilson, Alison, Figure 7ALT. TOP" ) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 5, colour = "black", 
                                   angle = 90, hjust = 0, vjust = 0.3),
        axis.text.y  = element_text(size = 6, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4),
        legend.position = "top",
        legend.text = element_text(size = 8, colour = "black"),
        legend.key.size = unit(0.2, "in"))
 
ggsave("figs/fig_7_charact_by_marker_ALTERNATIVE.tif", 
       plot = fig7alt, 
       device = device,
       width = fig_w_2, 
       height = fig_w,
       units = units,
       dpi = dpi)
 
```







# Figure 8
```{r}
functionality <- dat %>% 
  select(O, A, C, other_functionality) %>% 
  pivot_longer(cols = everything(), names_to = "type", values_to = "status") %>% 
  group_by(type, status) %>% 
  summarise(n = length(status)) %>% 
  ungroup(type, status)

# status
# recode status
functionality <- functionality %>%
  mutate(status = recode_factor(status,
                                p = "Performed",
                                m = "Mentioned",
                                n = "Not mentioned"))

functionality$status <- fct_relevel(functionality$status,
                                    "Not mentioned",
                                    "Mentioned",
                                    "Performed")
levels(functionality$status)

# recode functionality
functionality <- functionality %>%
  mutate(type = recode_factor(type,
                              other_functionality = "Other functionality",
                              C = "Chondrogenesis",
                              A = "Adipogenesis",
                              O = "Osteogenesis"))

functionality$type <- fct_relevel(functionality$type,
                                         "Other functionality",
                                         "Chondrogenesis",
                                         "Adipogenesis",
                                         "Osteogenesis")


```

```{r}
fig8 <- functionality %>% 
  ggplot() +
  geom_bar(aes(x = type, y = n, fill = status),
           stat = "identity", position = position_dodge()) +
  scale_fill_manual(values =  c("#BABABA", pal[c(2, 5)]),
                    name = "Assessment",
                    guide = guide_legend(nrow = 2, title.position = "top", title.hjust = 0.5 )) +
  scale_y_continuous(name = "Number of Articles",
                     breaks = seq(0, 80, 10),
                     minor_breaks = seq(0, 80, 10),
                     limits = c(0, 80),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0.5), name = "Functionality") +
  labs(title = "Wilson, Alison, Figure 8. TOP" ) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4),
        legend.position = "top",
        legend.text = element_text(size = 8, colour = "black"),
        legend.key.size = unit(0.2, "in")) +
  coord_flip()
 
ggsave("figs/fig_8_functionality_assessment.tif", 
       plot = fig8, 
       device = device,
       width = fig_w, 
       height = fig_w,
       units = units,
       dpi = dpi)
```



# Figure 9


## Relationship between MOA and stem/stromal

```{r}
moa_isct_summary <- dat %>% 
  group_by(MOA, stem_stromal) %>% 
  summarise(n = length(MOA))


dat %>% 
  group_by(stem_stromal) %>% 
  summarise(n = length(stem_stromal),
            pc = n/84)

res <- table(dat$stem_stromal, dat$MOA) %>% fisher.test(simulate.p.value = TRUE)
test_anno <- paste0("There is no significant association between MOA and cell categorisation\n(",
                   res$method, ": p = ", round(res$p.value, 3))

```

```{r moa-isct}
moa_isct <- moa_isct_summary %>% 
  ggplot(aes(x = MOA, y = n, fill = stem_stromal)) +
  geom_bar(stat = "identity", size = 0) +
  scale_fill_manual(values = pal, 
                    guide = guide_legend(nrow = 4, title = NULL)) +
  scale_y_continuous(name = "Number of Articles", 
                     breaks = seq(0, 45, 5),
                     minor_breaks = seq(0, 45, 5),
                     limits = c(0, 45),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = "Mechanism of action") +
  labs(title = "Wilson, Alison, Figure 9. TOP") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black",
                                   angle = -60, hjust = 0),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4),
        plot.caption = element_text(size = 4, hjust = 0),
        legend.position = c(0.7, 0.8),
        legend.text = element_text(size = 6, colour = "black"),
        legend.key.size = unit(0.2, "in"))
ggsave("figs/fig_9_moa_isct.tif", 
       plot = moa_isct, 
       device = device,
       width = fig_w, 
       height = fig_w,
       units = units,
       dpi = dpi)

```


## Figure 10 assocation between differentiation2 and MOA
```{r}
diffmoasum <- dat %>% group_by(MOA, differentiation_2) %>% 
  summarise(n = length(differentiation_2))


```

```{r}
moa_diff <- diffmoasum %>% 
  ggplot(aes(x = MOA, y = n, fill = differentiation_2)) +
  geom_bar(stat = "identity", size = 0) +
   scale_fill_manual(values = pal[c(2,5)], 
                    guide = guide_legend(nrow = 4, title = "Differentiation capacity"),
                    labels = c("Not demonstrated", "Demonstrated")) +
  scale_y_continuous(name = "Number of Articles", 
                     breaks = seq(0, 45, 5),
                     minor_breaks = seq(0, 45, 5),
                     limits = c(0, 45),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0), name = "Mechanism of action") +
  labs(title = "Wilson, Alison, Figure 10. TOP") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 8, colour = "black",
                                   angle = -60, hjust = 0),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(hjust = 0, size = 4),
        plot.caption = element_text(size = 4, hjust = 0),
        legend.position = c(0.7, 0.8),
        legend.text = element_text(size = 6, colour = "black"),
        legend.key.size = unit(0.2, "in"),
        legend.title = element_text(size = 8))
ggsave("figs/fig_10_moa_diff.tif", 
       plot = moa_diff, 
       device = device,
       width = fig_w, 
       height = fig_w,
       units = units,
       dpi = dpi)
  
```



```{r}
res <- table(dat$differentiation_2, dat$MOA) %>% fisher.test(simulate.p.value = TRUE)
chisq.test(table(dat$differentiation_2, dat$MOA))$exp;table(dat$differentiation_2, dat$MOA)
test_anno <- paste0("There is  significant association between MOA and demonstration of differentiation capacity(", res$method, ": p = ", round(res$p.value, 3),") with more studies demonstrating differentiation for Immune MOA, and fewer for Paracrine and Multiple MOA than expected.")
```
# CD values figures

```{r}
cd_dat_summary <- cd_dat %>% 
  group_by(Ref, marker) %>% 
  summarise(mean_value = mean(value),
            n = length(value),
            se_value = sd(value)/sqrt(n))
str(cd_dat_summary)
# length(unique(cd_dat$marker)) *length(unique(cd_dat$Ref))

# bind the range and the sinlge value dataframes
cd_dat_summary <- rbind(data.frame(cd_dat_summary), cd_dat2)

```


```{r}
# count the number of refs that have values
cd_refs_by_marker <- cd_dat_summary %>% 
  group_by(marker) %>%
  summarise(n_refs = length(mean_value[!is.na(mean_value)]))

cd_refs_by_marker$marker
isct <- c("Viability","CD73", "CD90", "CD105", "CD34", "CD45" , "CD11b", "CD14" , "CD79α", "CD19", "HLA-DR")
cd_refs_by_marker$ISCT <- "Other marker"
cd_refs_by_marker$ISCT[cd_refs_by_marker$marker %in% isct] <- "ISCT phenotype marker"

cd_refs_by_marker$ISCT <- fct_relevel(cd_refs_by_marker$ISCT,
                              "ISCT phenotype marker",
                              "Other marker")

```


```{r cd-refs-bar}
cd_refs_bar <- cd_refs_by_marker %>% 
  arrange(ISCT, n_refs) %>%
         mutate(marker = factor(marker, levels = marker) ) %>% 
  ggplot(aes(x = reorder(marker, ISCT), y = n_refs, fill = ISCT )) +
  geom_bar(stat = "identity",  size = 0) +
  xlab("") +
  scale_y_continuous(name = "Number of Articles", 
                     breaks = seq(0, 15, 1),
                     minor_breaks = seq(0, 15, 1),
                     limits = c(0, 15),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_fill_manual(values = pal[c(5, 2)], 
                    name = NULL) +
  labs(title = "Wilson, Alison, Figure X3. TOP" ) +
  annotate("segment", x = 0.5, xend = 10.5, 
           y = 14, yend = 14,
           colour = "black", size = 1) +
  annotate("segment", x = 0.58, xend = 0.58, 
           y = 14, yend = 13.5,
           colour = "black", size = 1) +
  annotate("segment", x = 10.38, xend = 10.38, 
           y = 14, yend = 13.5,
           colour = "black", size = 1) +
  annotate("text", x = 3,  y = 10, 
           label = "ISCT phenotype\nmarker", size = 4) +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        # legend.title = element_text(size = 8, colour = "black"),
        # legend.text = element_text(size = 8, colour = "black"),
        # legend.key.size = unit(0.2, "in"),
        # legend.position = c(0.7, 0.8),
        legend.position = "none",
        plot.title = element_text(hjust = 0, size = 4)) +
  coord_flip()

ggsave("figs/fig_x3_cd_refs_bar.tif", 
       plot = cd_refs_bar, 
       device = device,
       width = fig_w, 
       height = fig_w,
       units = units,
       dpi = dpi)

```

```{r}

cd_dat_summary_values <- cd_dat_summary %>% 
  filter(!is.na(mean_value))

cd_dat_summary_values$ISCT <- "Other marker"
cd_dat_summary_values$ISCT[cd_dat_summary_values$marker %in% isct] <- "ISCT phenotype marker"

cd_dat_summary_values$ISCT <- fct_relevel(cd_dat_summary_values$ISCT,
                              "ISCT phenotype marker",
                              "Other marker")
```

```{r}
cd_values_point_isct <- cd_dat_summary_values %>% 
  filter(ISCT == "ISCT phenotype marker") %>% 
  ggplot(aes(x = marker, y = mean_value)) +
  geom_pointrange(aes(ymin = mean_value - se_value, ymax = mean_value + se_value), 
                  position = position_jitter(width = 0.5), shape = 20) +
  xlab("") +
  scale_y_continuous(name = "Value reported", 
                     breaks = seq(0, 110, 10),
                     minor_breaks = seq(0, 110, 10),
                     limits = c(0, 110),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  labs(title = "Wilson, Alison, Figure X4. TOP" ) +
  geom_vline(xintercept = seq(1.5, 10.5, 1), linetype = "longdash") +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        # legend.title = element_text(size = 8, colour = "black"),
        # legend.text = element_text(size = 8, colour = "black"),
        # legend.key.size = unit(0.2, "in"),
        # legend.position = c(0.7, 0.8),
        legend.position = "none",
        plot.title = element_text(hjust = 0, size = 4))
ggsave("figs/fig_x4_cd_values_isct.tif", 
       plot = cd_values_point_isct, 
       device = device,
       width = fig_w_1.5, 
       height = fig_w,
       units = units,
       dpi = dpi)

```
 
```{r}
cd_values_point_other <- cd_dat_summary_values %>% 
  filter(ISCT == "Other marker") %>% 
  ggplot(aes(x = marker, y = mean_value)) +
  geom_pointrange(aes(ymin = mean_value - se_value, ymax = mean_value + se_value), 
                  position = position_jitter(width = 0.5), shape = 20) +
  xlab("") +
  scale_y_continuous(name = "Value reported", 
                     breaks = seq(0, 110, 10),
                     minor_breaks = seq(0, 110, 10),
                     limits = c(0, 110),
                     expand = c(0, 0)) +
  scale_x_discrete(expand = c(0, 0)) +
  labs(title = "Wilson, Alison, Figure X4. TOP" ) +
  geom_vline(xintercept = seq(1.5, 10.5, 1), linetype = "longdash") +
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.ticks.y = element_blank(),
        axis.text.y  = element_text(size = 8, colour = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        # legend.title = element_text(size = 8, colour = "black"),
        # legend.text = element_text(size = 8, colour = "black"),
        # legend.key.size = unit(0.2, "in"),
        # legend.position = c(0.7, 0.8),
        legend.position = "none",
        plot.title = element_text(hjust = 0, size = 4))
ggsave("figs/fig_x5_cd_values_isct.tif", 
       plot = cd_values_point_other, 
       device = device,
       width = fig_w_1.5, 
       height = fig_w,
       units = units,
       dpi = dpi)

```

```{r}


# disease targets
dat %>% group_by(Indication) %>% 
  summarise(n = length(Indication)) %>% 
  ggplot(aes(x = Indication, y = n)) +
  geom_bar(stat="identity")




```
















